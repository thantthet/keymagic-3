<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KeyMagic Configuration</title>
  </head>

  <body>
    <div class="app-container">
      <!-- Sidebar Navigation -->
      <nav class="sidebar">
        <div class="sidebar-header">
          <img src="assets/keymagic-logo.png" alt="KeyMagic" class="sidebar-logo">
          <h2>KeyMagic</h2>
        </div>
        
        <ul class="nav-list">
          <li class="nav-item active" data-page="keyboards">
            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M2 4.5C2 3.12 3.12 2 4.5 2h11C16.88 2 18 3.12 18 4.5v7C18 12.88 16.88 14 15.5 14h-11C3.12 14 2 12.88 2 11.5v-7zM4.5 3C3.67 3 3 3.67 3 4.5v7c0 .83.67 1.5 1.5 1.5h11c.83 0 1.5-.67 1.5-1.5v-7c0-.83-.67-1.5-1.5-1.5h-11z"/>
              <path d="M5 16.5c0-.28.22-.5.5-.5h9c.28 0 .5.22.5.5s-.22.5-.5.5h-9a.5.5 0 01-.5-.5z"/>
              <path d="M5 6h2v2H5V6zm3 0h2v2H8V6zm3 0h2v2h-2V6zm3 0h2v2h-2V6zM5 9h2v2H5V9zm3 0h2v2H8V9zm3 0h2v2h-2V9zm3 0h2v2h-2V9z"/>
            </svg>
            <span>Keyboards</span>
          </li>
          <li class="nav-item" data-page="settings">
            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
            </svg>
            <span>Settings</span>
          </li>
          <li class="nav-item" data-page="about">
            <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 2a8 8 0 100 16 8 8 0 000-16zM9 7a1 1 0 012 0v4a1 1 0 11-2 0V7zm1 8a1 1 0 100-2 1 1 0 000 2z"/>
            </svg>
            <span>About</span>
          </li>
        </ul>
        
        <div class="sidebar-section">
          <div class="sidebar-section-header">Developer Tools</div>
          <ul class="nav-list nav-list-developer">
            <li class="nav-item" data-page="converter">
              <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path d="M8 5a1 1 0 100 2h5.586l-1.293 1.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L13.586 5H8zm4 10a1 1 0 100-2H6.414l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L6.414 15H12z"/>
              </svg>
              <span>Create Keyboard</span>
            </li>
          </ul>
        </div>
        
      </nav>
      
      <!-- Main Content Area -->
      <main class="main-content">
        <!-- Keyboards Page -->
        <div class="page active" id="keyboards-page">
          <div class="page-header">
            <h1>Installed Keyboards</h1>
            <div class="header-actions">
              <button class="btn btn-primary" id="add-keyboard-btn">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M8 2a.5.5 0 01.5.5v5h5a.5.5 0 010 1h-5v5a.5.5 0 01-1 0v-5h-5a.5.5 0 010-1h5v-5A.5.5 0 018 2z"/>
                </svg>
                Add Keyboard
              </button>
            </div>
          </div>
          
          <div class="keyboard-list" id="keyboard-list">
            <!-- Keyboard cards will be inserted here -->
          </div>
        </div>
        
        <!-- Settings Page -->
        <div class="page" id="settings-page">
          <div class="page-header">
            <h1>Settings</h1>
          </div>
          
          <!-- Settings Tabs -->
          <div class="settings-tabs">
            <button class="settings-tab active" data-tab="general">General</button>
            <button class="settings-tab" data-tab="input-method">Input Method</button>
            <button class="settings-tab" data-tab="advanced">Advanced</button>
          </div>
          
          <div class="settings-content">
            <!-- General Tab -->
            <div class="settings-tab-panel active" data-panel="general">
              <section class="settings-section">
                <h2>Updates</h2>
                <div class="setting-item">
                  <div class="update-settings">
                    <div class="update-card">
                      <div class="update-card-content">
                        <div class="update-version-info">
                          <h3>KeyMagic 3</h3>
                          <p class="current-version">Version <span id="current-version">Loading...</span></p>
                        </div>
                        <button class="btn btn-primary" onclick="checkForUpdates()">Check for Updates</button>
                      </div>
                      <div class="update-status-container" id="update-status-container" style="display: none;">
                        <div class="update-status" id="update-status"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </div>
            
            <!-- Input Method Tab -->
            <div class="settings-tab-panel" data-panel="input-method">
              <section class="settings-section">
                <h2>KeyMagic Language Settings</h2>
              <div class="setting-item">
                <div class="language-settings">
                  <p class="setting-description" id="language-settings-description">Manage which languages KeyMagic appears under in Windows language settings.</p>
                  
                  <div class="language-selector-container">
                    <div class="language-search-section">
                      <input type="text" 
                             id="language-search" 
                             class="language-search-input" 
                             placeholder="Search languages (e.g., English, Myanmar, 中文)..."
                             autocomplete="off">
                      <div id="language-search-results" class="language-search-results hidden">
                        <!-- Search results will be inserted here -->
                      </div>
                    </div>
                    
                    <div class="enabled-languages-section">
                      <h3>Enabled Languages</h3>
                      <div id="enabled-languages-list" class="enabled-languages-list">
                        <!-- Enabled languages will be listed here -->
                      </div>
                      <div id="language-changes-actions" class="language-changes-actions hidden">
                        <p class="pending-changes-hint">You have pending changes. Click Apply to save them.</p>
                        <button class="btn btn-primary" onclick="applyLanguageChanges()">Apply Changes</button>
                        <button class="btn btn-secondary" onclick="cancelLanguageChanges()">Cancel</button>
                      </div>
                      <p class="setting-hint">KeyMagic will be available as an input method for these languages. Changes may require administrator privileges.</p>
                    </div>
                  </div>
                  
                  <div class="info-box collapsible-section collapsed" style="margin-top: 20px;">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                      <svg class="collapse-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M4.646 5.646a.5.5 0 01.708 0L8 8.293l2.646-2.647a.5.5 0 01.708.708l-3 3a.5.5 0 01-.708 0l-3-3a.5.5 0 010-.708z"/>
                      </svg>
                      <strong>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-right: 4px;">
                          <path d="M8 0a8 8 0 100 16A8 8 0 008 0zM7 4h2v5H7V4zm0 6h2v2H7v-2z"/>
                        </svg>
                        How to activate KeyMagic
                      </strong>
                    </div>
                    <div class="collapsible-content">
                      <p>KeyMagic appears as a keyboard option in your Windows keyboard layouts list. To activate or deactivate KeyMagic, simply switch between input methods using the system tray menu or the 
                        <span style="display: inline-flex; align-items: center; gap: 2px; font-family: monospace; background-color: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 3px;">
                          <img src="assets/windows-logo.svg" width="14" height="14" style="display: inline-block; vertical-align: middle;">
                          +Spacebar
                        </span> 
                        keyboard shortcut.</p>
                      <div class="screenshot-container">
                        <img src="assets/keymagic-in-system-tray.png" alt="KeyMagic in Windows system tray" class="help-screenshot">
                      </div>
                      <button class="btn btn-secondary" onclick="openWindowsInputSettings()">Open Windows Settings</button>
                      <p>To switch between different KeyMagic keyboards, use KeyMagic tray menu or keyboard-specific hotkeys configured in the <a href="#" onclick="switchPage('keyboards'); return false;">Keyboards page</a>.</p>
                    </div>
                  </div>
                </div>
              </div>
              </section>
              
              <section class="settings-section" id="ibus-settings-section" style="display: none;">
                <h2>IBus Configuration</h2>
                <div class="setting-item">
                  <div class="ibus-settings">
                    <p class="setting-description">View and manage KeyMagic's IBus input method configuration.</p>
                    
                    <div class="ibus-info-card">
                      <div class="ibus-info-content">
                        <div class="ibus-info-item">
                          <label>Display Symbol:</label>
                          <span id="ibus-symbol" class="ibus-value">Loading...</span>
                        </div>
                        <div class="ibus-info-item">
                          <label>Configuration File:</label>
                          <span class="ibus-value mono">/usr/share/ibus/component/keymagic3.xml</span>
                        </div>
                      </div>
                    </div>
                    
                    <div class="info-box collapsible-section collapsed" style="margin-top: 16px;">
                      <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <svg class="collapse-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                          <path d="M4.646 5.646a.5.5 0 01.708 0L8 8.293l2.646-2.647a.5.5 0 01.708.708l-3 3a.5.5 0 01-.708 0l-3-3a.5.5 0 010-.708z"/>
                        </svg>
                        <strong>How to change the symbol</strong>
                      </div>
                      <div class="collapsible-content">
                        <p>To change the KeyMagic display symbol in IBus:</p>
                        <ol>
                          <li>Edit the configuration file with sudo:
                            <pre><code>sudo nano /usr/share/ibus/component/keymagic3.xml</code></pre>
                          </li>
                          <li>Find the <code>&lt;symbol&gt;</code> tag and change its value</li>
                          <li>Save the file and restart IBus:
                            <pre><code>ibus restart</code></pre>
                          </li>
                        </ol>
                        <p><strong>Note:</strong> This requires administrator privileges and will affect all users on the system.</p>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
              
              <section class="settings-section" id="imk-management-section" style="display: none;">
                <h2>Input Method Management</h2>
                <div class="setting-item">
                  <div class="imk-management-settings">
                    <p class="setting-description">Manage the KeyMagic Input Method Kit (IMK) component that enables typing in macOS applications.</p>
                    
                    <div class="imk-status-card">
                      <div class="imk-status-content">
                        <div class="imk-status-info">
                          <h3>KeyMagic Input Method</h3>
                          <p class="imk-status-text" id="imk-status-text">Checking status...</p>
                        </div>
                        <div class="imk-actions">
                          <button class="btn btn-secondary" id="reinstall-imk-btn" onclick="reinstallIMK()" style="display: none;">
                            Reinstall Input Method
                          </button>
                          <button class="btn btn-danger" id="uninstall-imk-btn" onclick="uninstallIMK()" style="display: none;">
                            Uninstall Input Method
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <div class="info-box" style="margin-top: 16px;">
                      <p><strong>Note:</strong> The Input Method component is required for KeyMagic to work in macOS applications. You only need to uninstall it if you want to completely remove KeyMagic from your system. Uninstalling will disable KeyMagic typing functionality until it's reinstalled.</p>
                    </div>
                  </div>
                </div>
              </section>
            </div>
            
            <!-- Advanced Tab -->
            <div class="settings-tab-panel" data-panel="advanced">
              <section class="settings-section" id="preview-window-section" style="display: none;">
              <h2>Keyboard Preview</h2>
              <div class="setting-item">
                <div class="preview-window-settings">
                  <p class="setting-description">Show a preview of the keyboard layout when hovering over the KeyMagic tray icon.</p>
                  <div class="toggle-setting">
                    <label class="toggle-switch">
                      <input type="checkbox" id="preview-window-enabled" onchange="togglePreviewWindow()">
                      <span class="toggle-slider"></span>
                    </label>
                    <label for="preview-window-enabled" class="toggle-label">Enable keyboard preview on hover</label>
                  </div>
                  <p class="setting-hint">When enabled, hovering over the KeyMagic icon in the system tray will show a visual preview of the active keyboard layout.</p>
                </div>
              </div>
            </section>
            
            <section class="settings-section" id="composition-mode-section">
              <h2>Composition Mode</h2>
              <div class="setting-item">
                <div class="composition-mode-settings">
                  <p class="setting-description">Configure which applications use composition mode (text appears with underline while typing) instead of direct mode.</p>
                  <div class="process-list-container">
                    <div class="process-list-header">
                      <h3>Applications</h3>
                      <button class="btn btn-secondary btn-sm" onclick="addHostToCompositionMode()">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                          <path d="M8 2a.5.5 0 01.5.5v5h5a.5.5 0 010 1h-5v5a.5.5 0 01-1 0v-5h-5a.5.5 0 010-1h5v-5A.5.5 0 018 2z"/>
                        </svg>
                        Add Application
                      </button>
                    </div>
                    <div class="process-list" id="composition-mode-process-list">
                      <!-- Process items will be inserted here -->
                    </div>
                    <p class="setting-hint">These applications will show text with an underline while typing. All other applications will use direct text input.</p>
                  </div>
                </div>
              </div>
            </section>
            
            <section class="settings-section" id="direct-mode-section" style="display: none;">
              <h2>Direct Mode App Bundles</h2>
              <div class="setting-item">
                <div class="direct-mode-settings">
                  <p class="setting-description">Configure which applications use direct mode (text appears immediately) instead of composition mode.</p>
                  <div class="process-list-container">
                    <div class="process-list-header">
                      <h3>App Bundles</h3>
                      <button class="btn btn-secondary btn-sm" onclick="addHostToDirectMode()">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                          <path d="M8 2a.5.5 0 01.5.5v5h5a.5.5 0 010 1h-5v5a.5.5 0 01-1 0v-5h-5a.5.5 0 010-1h5v-5A.5.5 0 018 2z"/>
                        </svg>
                        Add App Bundle
                      </button>
                    </div>
                    <div class="process-list" id="direct-mode-process-list">
                      <!-- Process items will be inserted here -->
                    </div>
                    <p class="setting-hint">These applications will use direct text input. All other applications will show text with an underline while typing.</p>
                  </div>
                </div>
              </div>
            </section>
            </div>
          </div>
        </div>
        
        <!-- Converter Page -->
        <div class="page" id="converter-page">
          <div class="page-header">
            <h1>Create KeyMagic Keyboard</h1>
          </div>
          
          <div class="converter-content">
            <section class="converter-section">
              <h2>Build from KeyMagic Script</h2>
              <p class="converter-description">Convert KeyMagic Script (.kms) files to binary keyboard (.km2) format.</p>
              
              <div class="converter-form">
                <div class="file-input-section">
                  <label for="kms-file-input" class="file-input-label">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M9 2a1 1 0 00-1 1v5H3a1 1 0 100 2h5v5a1 1 0 102 0v-5h5a1 1 0 100-2h-5V3a1 1 0 00-1-1z"/>
                    </svg>
                    Choose KMS File
                  </label>
                  <input type="file" id="kms-file-input" accept=".kms" style="display: none;">
                  <div id="selected-file-info" class="selected-file-info"></div>
                </div>
                
                <div id="validation-result" class="validation-result" style="display: none;"></div>
                
                <div class="converter-actions">
                  <button class="btn btn-primary" id="convert-btn" disabled>
                    Convert to KM2
                  </button>
                  <button class="btn btn-secondary" id="convert-and-import-btn" disabled>
                    Convert & Import
                  </button>
                </div>
                
                <div id="conversion-result" class="conversion-result" style="display: none;"></div>
              </div>
            </section>
            
            <section class="converter-section">
              <h2>About KeyMagic Files</h2>
              <div class="info-box">
                <p><strong>KMS (KeyMagic Keyboard Layout Script)</strong> files are text-based keyboard layout definitions written in a human-readable scripting language. They use simple syntax to define how keystrokes are transformed into characters, making it easy to create and modify keyboard layouts for various languages and writing systems.</p>
                <p><strong>KM2 (KeyMagic Keyboard Layout Binary)</strong> files are the compiled version of KMS scripts. The compiler validates syntax, optimizes rules for fast pattern matching, and packages everything—including icons and resources—into a single binary file that KeyMagic loads at runtime.</p>
              </div>
            </section>
          </div>
        </div>
        
        <!-- About Page -->
        <div class="page" id="about-page">
          <div class="page-header">
            <h1>About KeyMagic</h1>
          </div>
          
          <div class="about-content">
            <div class="about-logo">
              <img src="assets/keymagic-logo.png" alt="KeyMagic Logo" width="128" height="128">
            </div>
            <h2>KeyMagic 3</h2>
            <p>A powerful input method editor for typing in various languages.</p>
            <p class="version-info">Version <span id="about-version">-</span> - Built with Rust and Tauri</p>
            <div class="about-links">
              <a href="https://keymagic.net" target="_blank">Website</a>
              <a href="https://github.com/thantthet/keymagic-3" target="_blank">GitHub</a>
            </div>
          </div>
        </div>
      </main>
    </div>
    
    <!-- Modal for dialogs -->
    <div class="modal" id="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title"></h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body"></div>
        <div class="modal-footer"></div>
      </div>
    </div>
    
    <!-- Load main.js at the end of body -->
    <script type="module" src="main.js"></script>
  </body>
</html>
